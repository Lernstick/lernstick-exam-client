#!/usr/bin/env python3

import sys # sys.path.append()
import time # time.sleep()
import requests # requests.get()

directory = "/var/lib/lernstick-exam-client/"
sys.path.append(directory)
import functions as helpers # get_info(), get_env(), run()

INFO_FILE_URL = 'urlDownload'
interval = 1 #seconds
duration = 120 # iterations
width = 260 # pixels
icon_size = "16x16"
icon_fmt = "gif"
screenshot_cmd = 'import -silent -window root -resize "{width}" jpg:-'
icon_cmd = "xprop -id {window_id} -notype 32c _NET_WM_ICON | perl -0777 -pe '@_=/\d+/g; printf \"P7\\nWIDTH %d\\nHEIGHT %d\\nDEPTH 4\\nMAXVAL 255\\nTUPLTYPE RGB_ALPHA\\nENDHDR\\n\", splice@_,0,2; $_=pack \"N*\", @_; s/(.)(...)/$2$1/gs' | convert - -geometry \"{icon_size}\" {icon_fmt}:-"

url = helpers.get_info(INFO_FILE_URL)
if url == False:
    print('Variable "${variable}" not found in {file}.'.format(
        variable = INFO_FILE_URL,
        file = '/info'
    ))
    exit(1)

url = url.replace('download', 'live', 1)
display = helpers.get_env("DISPLAY")
xauthority = helpers.get_env("XAUTHORITY")

last_icon, last_window  = None, None

for i in range(0, duration):
    env = {'DISPLAY': display, 'XAUTHORITY': xauthority}
    success, window_id = helpers.run('xdotool getactivewindow', env = env)
    if success:
        _, window = helpers.run('xdotool getactivewindow getwindowname', env = env)
        _, icon = helpers.run(icon_cmd.format(
            window_id = window_id,
            icon_size = icon_size,
            icon_fmt = icon_fmt
        ), env = env, encoding = None)
    else:
        window, icon = '', ''

    _, img = helpers.run(screenshot_cmd.format(width = width), env = env, encoding = None)
    data = {'window': window} if last_window != window else {}
    files = {'img': img, 'icon': icon} if last_icon != icon else {'img': img}
    last_icon, last_window = icon, window
    
    r = requests.post(url, files = files, data = data)
    time.sleep(interval)

#!/bin/bash

# source the info file
. /info

# get DISPLAY and XAUTHORITY env vars
set -o allexport
. <(strings /proc/*/environ 2>/dev/null | awk -F= '$1=="DISPLAY"||$1=="XAUTHORITY"' | head -2)
set +o allexport

interval="1" #seconds
width="260"
url=${urlLive:-${urlDownload/download/live}}
duration="100" # iterations
icon_size="16x16"
icon_fmt="gif"
tmp_file="$(mktemp --suffix ".${icon_fmt}")"

i=0
while [ "$i" -lt "$duration" ]; do
  window="$(xdotool getactivewindow getwindowname 2>/dev/null || echo "")"

  if xdotool getactivewindow; then
    # icon of the active window
    xprop -id "$(xdotool getactivewindow)" -notype 32c _NET_WM_ICON | perl -0777 -pe '@_=/\d+/g;
      printf "P7\nWIDTH %d\nHEIGHT %d\nDEPTH 4\nMAXVAL 255\nTUPLTYPE RGB_ALPHA\nENDHDR\n", splice@_,0,2;
      $_=pack "N*", @_;
      s/(.)(...)/$2$1/gs' | convert - -geometry "${icon_size}" "${tmp_file}"
  else
    >"${tmp_file}"
  fi

  import -silent -window root -resize "${width}" jpg:- | \
    curl -F "window=${window}" -F "img=@-" -F "icon=@${tmp_file}" "${url}"

  sleep ${interval}
  i=$((i+$interval))
done
